env:
    global:
        - REPO_DIR=.
        # Commit from your-project that you want to build
        - BUILD_COMMIT=HEAD
        # pip dependencies to _build_ your project
        - BUILD_DEPENDS="numpy"
        # pip dependencies to _test_ your project.  Include any dependencies
        # that you need, that are also specified in BUILD_DEPENDS, this will be
        # a separate install.
        - TEST_DEPENDS="numpy nose"
        - PLAT=x86_64
        - UNICODE_WIDTH=32
        - WHEELHOUSE_UPLOADER_USERNAME=bbp.opensource
        - DOCKER_IMAGE=bluebrain/morphio_wheel

language: python
# The Travis Python version is unrelated to the version we build and test
# with.  This is set with the MB_PYTHON_VERSION variable.
python: 3.5
dist: trusty
services: docker

matrix:
  exclude:
    # Exclude the default Python 3.5 build
    - python: 3.5
  include:
    - os: linux
      env: MB_PYTHON_VERSION=2.7
    # - os: linux
    #   env:
    #     - MB_PYTHON_VERSION=2.7
    #     - UNICODE_WIDTH=16
    # - os: linux
    #   env:
    #     - MB_PYTHON_VERSION=2.7
    #     - PLAT=i686
    # - os: linux
    #   env:
    #     - MB_PYTHON_VERSION=2.7
    #     - PLAT=i686
    #     - UNICODE_WIDTH=16
    # - os: linux
    #   env:
    #     - MB_PYTHON_VERSION=3.4
    # - os: linux
    #   env:
    #     - MB_PYTHON_VERSION=3.4
    #     - PLAT=i686
    # - os: linux
    #   env:
    #     - MB_PYTHON_VERSION=3.5
    # - os: linux
    #   env:
    #     - MB_PYTHON_VERSION=3.5
    #     - PLAT=i686
    # - os: linux
    #   env:
    #     - MB_PYTHON_VERSION=3.6
    # - os: linux
    #   env:
    #     - MB_PYTHON_VERSION=3.6
    #     - PLAT=i686
    # - os: osx
    #   language: generic
    #   env:
    #     - MB_PYTHON_VERSION=2.7
    # - os: osx
    #   language: generic
    #   env:
    #     - MB_PYTHON_VERSION=3.4
    # - os: osx
    #   language: generic
    #   env:
    #     - MB_PYTHON_VERSION=3.5
    # - os: osx
    #   language: generic
    #   env:
    #     - MB_PYTHON_VERSION=3.6
    # - os: osx
    #   language: generic
    #   env:
    #     - MB_PYTHON_VERSION=pypy-5.7

before_install:
    - source multibuild/common_utils.sh
    - source multibuild/travis_steps.sh
    - clean_code $REPO_DIR $BUILD_COMMIT
    - before_install

install:
    # Maybe get and clean and patch source
    - build_wheel $REPO_DIR $PLAT

script:
    - install_run $PLAT

after_success:
    # Copy compiled wheels to dist/ where Travis `dpl` tool can find them and
    # upload to PyPI
    - mkdir -p dist; cp ${TRAVIS_BUILD_DIR}/wheelhouse/*.whl dist
    - python setup.py sdist

# Deploy to PyPI on tags. Since the hard work of building wheels is already
# done, we need to defeat some of Travis' automation.
# Inspired from:
# https://github.com/madig/freetype-py/blob/bc944ef10a5648b88b25819e12de9853470f53de/.travis.yml
deploy:
  provider: pypi
  server: https://test.pypi.org/legacy/
  on:
    all_branches: true
    tags: true
  user: wizmer  # to be replaced by bbp.opensource
  password:
    secure: "RyRupjlunVNdA9FjtaT/pP8Zuh2BViA7LYxUuS9TMg6M9Ry8I4uVOuzGr6By8QFcnHTjb8quKDxypXa65zNt98RPRLOnU1KSC4gT+3PndXdcqa+7EA4aVV0pHlBgvx5KH3aihZKPMrhTp38rOSgQV/Dpu6PhVoQXyrq/QW/7o5fVzNKDw6mTzWjd0rhTPDA9EU4DkyNmwx+tQVdpRwDnnqbR7viA2YfxxslcXdm/141/guZaozrj8kazvZCodBj6SpfJKWTkDgFbzZICC0y4dSEsq5292JJBFX5nCDANhbVi1jSdD3nTH1Q9081hj6uQBzQEtoKkiLXnxOHUN1PyzrVmCBZAlHwv+fC3/UBNypL1NRBb5ka1i5MFlbLm0j5lvpMGGdwX1p1pVWncOtcUtJhpKRBEpkfyxI120KYGQ+WXbQ6DnOVrXRq83cFJ2AZy+y72QvN9RWaHEnn7iueZ2WH5jWsDxHEya3TM1kphp91HHvUHVGyosyquGF9bm6xays4/Bz60o4xF/KxxBkcyK9w5DRriC73Rj+s/MKXVa7AQBH6vpO+BJab8QAndFQcD0jqAacCD3y+rQr+949cyoDauHKoOikCr1VkF36dCWqCmZ1LD3KRfu0OlZVueYwA95lLAapGyfV80ck1UuCmsCx8IuHpsUv+453cLSN8s74A="
  skip_cleanup: true  # Prevent deletion of dist/*.
  distributions: check  # Dummy argument so dists aren't rebuilt by dpl.
